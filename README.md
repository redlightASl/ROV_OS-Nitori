# Nitori-ROV-OS

一个专门为水下机器人（ROV、AUV）进行优化的实时操作系统，暂命名为`Nitori`

可以通过修改硬件兼容层（Port）进行移植

预计最初版本支持stm32h750，并在实验室目前的水下机器人中进行部署

系统分为四层，六个主要组件：

* 硬件兼容层：用于移植到不同的硬件项目，只要修改少数关键API即可实现同型号内核间移植

    组件：Port

* 内核层：包括了一个极其微型的抢占式操作系统内核，能够实现时间片轮转调度、信号量、互斥量、消息队列功能

    组件：Sys	Thread

* 硬件抽象层：使用Port组件中定义的API对底层寄存器进行控制，自带了许多常用的控制算法和一些特殊算法，可以实现对PWM设备的高效率调用、根据经验公式控制任意数量的水下推进器、灵活的机械臂控制和可以快速调参（甚至实现自整定）的PID控制

    组件：BasicCtrl	Algorithm

* 传感器控制层：通过指针直接控制底层传感器数据采集，可以实现按照硬件抽象层的统一接口直接控制底层传感器数据，同时预留了硬件加速和AUV的编程接口，用于后续配合其他先进机型

    组件：Sensor

### OurEDA水下机器人控制库

本项目的前身，一个可快速部署于水下机器人下位机的控制库，并可针对所需传感器、舵机、推进器和上下传数据流格式进行裁剪

基于HAL硬件抽象层和STM32HAL库构建，可通过移植底层函数快速适配各种主控IC

分为以下几个版本：

* V1.0：最初版本，使用指针和库内部的全局变量实现。适合于快速移植，但代码较难看懂
* V2.0：使用结构体封装和位运算实现。封装较完善，但效率相对较低，但较容易理解，此外该版本存在一些bug有待修复
* V3.0：V2.0的衍生版本，修复了可能存在的控制指令下传不正确的bug，改正了大端存储数据和小端存储数据
* V4.0：最新迭代。增强代码稳健性，加入声呐传感器驱动，优化代码结构，但是传感器读取与延迟部分还存在问题
* V5.0：目前正在筹划的版本。使用c面向对象重写，可基于FreeRTOS/RT-Thread快速部署到任何主控的机器人上，支持统一的传感器数据传输接口和PWM驱动，允许最多三个从设备进行级联，支持驱动ASIC/FPGA。效率降低，但是由于机器人将要全部使用stm32h750甚至更高性能的内核，效率损失可以忽略
* V6.0：画大饼版本。使用c面向对象重写，底层基于指针和寄存器，紧密耦合基于ROV优化的FPGA软核，自带任务调度器、互斥量、邮箱，通过硬件直接解析传感器数据、控制PWM，自带PID、卡尔曼滤波、奇偶校验算法，效率极高，一个经过特殊优化的RTOS

其中V5.0、V6.0版本被直接分割为`Nitori-OS`的V1.0版本进行开发

### 基本功能

* 对stm32（Cortex-M系列内核）-HAL库的底层软硬件支持
* ~~对RISC-V（RV32IM指令集）的底层软硬件支持~~
* 基于systick实现的系统时钟
* 多任务时间片轮转调度
* 信号量、互斥量、消息队列（邮箱）
* PWM设备驱动
* 使用十六进制数据解析的串口传感器驱动框架
* 支持多mcu级联数据传输
* 快速定义数据上传协议
* FPGA自定义寄存器控制API
